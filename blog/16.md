---
title: TuGgraph-Analytics图计算快速上手之紧密中心度算法
date: 2023-9-20
---

<font style="color:rgb(69, 69, 69);">作者：张武科</font>

## <font style="color:rgb(69, 69, 69);">概述</font>

**<font style="color:rgb(69, 69, 69);">紧密中心度（Closeness Centrality）</font>**<font style="color:rgb(69, 69, 69);">计量了一个节点到其他所有节点的紧密性，即该节点到其他节点的距离的倒数；节点对应的值越高表示紧密性越好，能够在图中传播信息的能力越强，可用以衡量信息流入或流出该节点的能力，多用与社交网络中关键节点发掘等场景。</font>

<!-- truncate -->

## <font style="color:rgb(69, 69, 69);">算法介绍</font>

<font style="color:rgb(69, 69, 69);">对于图中一个给定节点，紧密性中心性是该节点到其他所有节点的最小距离和的倒数：</font>![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1755590978534-43f77402-6915-402d-b006-8e0ded89d446.png)

<font style="color:rgb(69, 69, 69);">其中，u 表示待计算紧密中心度的节点，d(u, v)表示节点 u 到节点 v 的最短路径距离；实际场景中，更多地使用归一化后的紧密中心度，即计算目标节点到其他节点的平均距离的倒数：</font>![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1755590977672-e3a5154a-a7a8-4d37-b701-184526bc6f75.png)

<font style="color:rgb(69, 69, 69);">其中，n 表示图中节点数。</font>

## <font style="color:rgb(69, 69, 69);">算法实现</font>

<font style="color:rgb(69, 69, 69);">首先，基于</font>`<font style="color:rgb(69, 69, 69);background-color:rgb(238, 238, 238);">AlgorithmUserFunction</font>`<font style="color:rgb(69, 69, 69);">接口实现</font>`<font style="color:rgb(69, 69, 69);background-color:rgb(238, 238, 238);">ClosenessCentrality</font>`<font style="color:rgb(69, 69, 69);">，如下：</font>

```plain
@Description(name = "closeness_centrality", description = "built-in udga for ClosenessCentrality")
public class ClosenessCentrality implements AlgorithmUserFunction<Long, Long> {

    private AlgorithmRuntimeContext context;
    private long sourceId;

    @Override
    public void init(AlgorithmRuntimeContext context, Object[] params) {
        this.context = context;
        if (params.length != 1) {
            throw new IllegalArgumentException("Only support one arguments, usage: func(sourceId)");
        }
        this.sourceId = ((Number) params[0]).longValue();
    }

    @Override
    public void process(RowVertex vertex, Iterator<Long> messages) {
        List<RowEdge> edges = context.loadEdges(EdgeDirection.OUT);
        if (context.getCurrentIterationId() == 1L) {
            context.sendMessage(vertex.getId(), 1L);
            context.sendMessage(sourceId, 1L);
        } else if (context.getCurrentIterationId() == 2L) {
            context.updateVertexValue(ObjectRow.create(0L, 0L));
            if (vertex.getId().equals(sourceId)) {
                long vertexNum = -2L;
                while (messages.hasNext()) {
                    messages.next();
                    vertexNum++;
                }
                // 统计节点数
                context.updateVertexValue(ObjectRow.create(0L, vertexNum));
                // 向邻接点发送与目标点距离
                sendMessageToNeighbors(edges, 1L);
            }
        } else {
            if (vertex.getId().equals(sourceId)) {
                long sum = (long) vertex.getValue().getField(0, LongType.INSTANCE);
                while (messages.hasNext()) {
                    sum += messages.next();
                }
                long vertexNum = (long) vertex.getValue().getField(1, LongType.INSTANCE);
                // 记录最短距离和
                context.updateVertexValue(ObjectRow.create(sum, vertexNum));
            } else {
                if (((long) vertex.getValue().getField(1, LongType.INSTANCE)) < 1) {
                    Long meg = messages.next();
                    context.sendMessage(sourceId, meg);
                    // 向邻接点发送与目标点距离
                    sendMessageToNeighbors(edges, meg + 1);
                    // 标记该点已向目标点发送过消息
                    context.updateVertexValue(ObjectRow.create(0L, 1L));
                }
            }
        }
    }

    private void sendMessageToNeighbors(List<RowEdge> outEdges, Object message) {
        for (RowEdge rowEdge : outEdges) {
            context.sendMessage(rowEdge.getTargetId(), message);
        }
    }

    @Override
    public void finish(RowVertex vertex) {
        if (vertex.getId().equals(sourceId)) {
            long len = (long) vertex.getValue().getField(0, LongType.INSTANCE);
            long num = (long) vertex.getValue().getField(1, LongType.INSTANCE);
            context.take(ObjectRow.create(vertex.getId(), (double) num / len));
        }
    }

    @Override
    public StructType getOutputType() {
        return new StructType(
            new TableField("id", LongType.INSTANCE, false),
            new TableField("cc", DoubleType.INSTANCE, false)
        );
    }
}
```

<font style="color:rgb(69, 69, 69);">然后，可在 DSL 中引入自定义算法，直接调用使用，语法形式如下：</font>

```plain
CREATE Function closeness_centrality AS 'com.antgroup.geaflow.dsl.udf.ClosenessCentrality';

INSERT INTO tbl_result
CALL closeness_centrality(1) YIELD (vid, ccValue)
RETURN vid, ROUND(ccValue, 3)
;
```

<font style="color:rgb(69, 69, 69);">示例表示，计算图中</font><font style="color:rgb(69, 69, 69);"> </font>`<font style="color:rgb(69, 69, 69);background-color:rgb(238, 238, 238);">id = 1</font>`<font style="color:rgb(69, 69, 69);">节点的紧密中心度。</font>

## <font style="color:rgb(69, 69, 69);">算法运行</font>

<font style="color:rgb(69, 69, 69);">在运行算法之前，要构造算法运行的底图数据。</font>

### <font style="color:rgb(69, 69, 69);">图定义</font>

<font style="color:rgb(69, 69, 69);">首先，进行图定义：</font>

```plain
CREATE GRAPH modern (
	Vertex person (
	  id bigint ID,
	  name varchar,
	  age int
	),
	Vertex software (
	  id bigint ID,
	  name varchar,
	  lang varchar
	),
	Edge knows (
	  srcId bigint SOURCE ID,
	  targetId bigint DESTINATION ID,
	  weight double
	),
	Edge created (
	  srcId bigint SOURCE ID,
  	targetId bigint DESTINATION ID,
  	weight double
	)
) WITH (
	storeType='rocksdb',
	shardNum = 1
);
```

### <font style="color:rgb(69, 69, 69);">图构建</font>

<font style="color:rgb(69, 69, 69);">完成图定义之后，导入点边数据，构造数据底图：</font>

```plain
CREATE TABLE modern_vertex (
  id varchar,
  type varchar,
  name varchar,
  other varchar
) WITH (
  type='file',
  geaflow.dsl.file.path = 'resource:///data/modern_vertex.txt'
);

CREATE TABLE modern_edge (
  srcId bigint,
  targetId bigint,
  type varchar,
  weight double
) WITH (
  type='file',
  geaflow.dsl.file.path = 'resource:///data/modern_edge.txt'
);

INSERT INTO modern.person
SELECT cast(id as bigint), name, cast(other as int) as age
FROM modern_vertex WHERE type = 'person'
;

INSERT INTO modern.software
SELECT cast(id as bigint), name, cast(other as varchar) as lang
FROM modern_vertex WHERE type = 'software'
;

INSERT INTO modern.knows
SELECT srcId, targetId, weight
FROM modern_edge WHERE type = 'knows'
;

INSERT INTO modern.created
SELECT srcId, targetId, weight
FROM modern_edge WHERE type = 'created'
;
```

### <font style="color:rgb(69, 69, 69);">计算输出</font>

<font style="color:rgb(69, 69, 69);">最后，在底图数据上完成算法计算和结果输出；</font>

```plain
CREATE TABLE tbl_result (
  vid int,
	ccValue double
) WITH (
	type='file',
	geaflow.dsl.file.path='/tmp/result'
);

CREATE Function closeness_centrality AS 'com.antgroup.geaflow.dsl.udf.ClosenessCentrality';

USE GRAPH modern;

INSERT INTO tbl_result
CALL closeness_centrality(1) YIELD (vid, ccValue)
RETURN vid, ROUND(ccValue, 3)
;
```

### <font style="color:rgb(69, 69, 69);">运行示例</font>

- <font style="color:rgb(69, 69, 69);">input ```sql // vertex 1,person,marko,29 2,person,vadas,27 3,software,lop,java 4,person,josh,32 5,software,ripple,java 6,person,peter,35</font>

<font style="color:rgb(69, 69, 69);">// edge 1,3,created,0.4 1,2,knows,0.5 1,4,knows,1.0 4,3,created,0.4 4,5,created,1.0 3,6,created,0.2</font>

````plain
- output
```sql
// result
1,0.714
````

## <font style="color:rgb(69, 69, 69);">结语</font>

<font style="color:rgb(69, 69, 69);">在本篇文章中我们介绍了如何在 TuGraph Analytics 上实现紧密中心度算法，如果你觉得比较有趣，欢迎关注我们的社区（</font>[<font style="color:rgb(255, 81, 0);">https://github.com/TuGraph-family/tugraph-analytics</font>](https://github.com/TuGraph-family/tugraph-analytics)<font style="color:rgb(69, 69, 69);">）。开源不易，如果你觉得还不错，可以给我们 star 支持一下～</font>

---

<font style="color:rgb(69, 69, 69);">GeaFlow(品牌名 TuGraph-Analytics) 已正式开源，欢迎大家关注！！！</font>

<font style="color:rgb(69, 69, 69);">欢迎给我们 Star 哦!</font>

<font style="color:rgb(69, 69, 69);">Welcome to give us a Star!</font>

<font style="color:rgb(69, 69, 69);">GitHub</font><font style="color:rgb(69, 69, 69);">👉</font>[<font style="color:rgb(255, 81, 0);">https://github.com/TuGraph-family/tugraph-analytics</font>](https://github.com/TuGraph-family/tugraph-analytics)

#### <font style="color:rgb(69, 69, 69);">微信群</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1755590976984-5fee7369-5c67-4557-bf20-04344aab49b0.png)

<font style="color:rgb(69, 69, 69);">请点击项目链接下方微信二维码添加微信用户群：</font>[<font style="color:rgb(255, 81, 0);">https://github.com/TuGraph-family/tugraph-analytics</font>](https://github.com/TuGraph-family/tugraph-analytics)
