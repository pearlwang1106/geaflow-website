---
title: GeaFlow图数据集成：表到图的最后一公里
date: 2024-2-4
---

## <font style="color:rgb(63, 63, 63);">图数据集成</font>

<font style="color:rgb(63, 63, 63);">小伙伴们想玩一玩图计算，数据的导入工作总是绕不开的一个环节。为了降低大家数据导入操作的成本，提升图计算的整体使用体验，GeaFlow 推出了“图数据集成”能力，帮助大家通过简单配置完成数据导入工作。</font>

<!-- truncate -->

<font style="color:rgb(63, 63, 63);">要实现图上的数据处理，可大致分为三个阶段：</font>

1. **<font style="color:rgb(38, 75, 239);">数据准备</font>**<font style="color:rgb(63, 63, 63);">：准备图的点边的原始数据。如文件（CSV/JSON）、Hive 表、Kafka 消息队列等数据源。</font>
2. **<font style="color:rgb(38, 75, 239);">数据导入</font>**<font style="color:rgb(63, 63, 63);">：将原始的表结构数据（结构化/半结构化）格式化成图结构写入图引擎。一般采用编写 SQL 或基于引擎 API 开发数据导入任务。</font>
3. **<font style="color:rgb(38, 75, 239);">数据分析</font>**<font style="color:rgb(63, 63, 63);">：基于图引擎对已经导入的图格式数据分析处理。一般使用 GQL、Gremlin、Cypher 等图分析语言处理，复杂的图算法（图上的迭代、采用、推理等）可能需要用户自己开发 UDF。（Java/Python）</font>

<font style="color:rgb(63, 63, 63);">因此，实现图上的数据分析的前置动作便是图数据导入，简称“构图”。这里我们使用“图数据集成”的说法，是沿用了传统数据仓库里“数据集成”的概念。</font>

<font style="color:rgb(63, 63, 63);">GeaFlow 可以通过编写 SQL 代码实现高效的数据导入到图的能力。但当数据源头和表字段过多时，编写出来的 DSL 代码往往非常冗长，而且用户手动编写的代码容易出现插入的字段映射错位、数量不匹配等问题。为此，GeaFlow 的 Console 平台为用户提供了到图的一键“数据集成”功能，允许用户可在界面中选择输入表和对应的目标点边，平台会自动化生成对应的 DSL 代码，实现图数据导入，避免了大量冗长的代码的编写和校对工作。</font>

## <font style="color:rgb(63, 63, 63);">任务设计</font>

<font style="color:rgb(63, 63, 63);">类似传统数据库表的 INSERT 操作，图数据集成则是向图的点边表插入数据。图中的点边也是一种表结构，每个点边都有相应的属性（对应表结构中的字段），并可以与数据源的表字段一一映射。所以可以通过给定外部输入表和目标点边的映射关系来描述图数据集成任务。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793045504-5e25f725-8a31-4b38-8b68-298ddf4e49bb.webp)

<font style="color:rgb(136, 136, 136);">表图字段映射</font>

<font style="color:rgb(63, 63, 63);">图数据集成任务维护了用户填写的输入表到图的目标点边的映射关系。映射关系结构为 StructMapping 的数组，每个 StructMapping 包含了表名、图名、和对应的字段映射项列表。</font>

```plain
@EqualsAndHashCode(of = {"tableName", "structName"})
public static class StructMapping {
    private String tableName;
    private String structName;
    private List<FieldMappingItem> fieldMappings = new ArrayList<>();
}

@EqualsAndHashCode(of = {"tableFieldName", "structFieldName"})
public static class FieldMappingItem {
    private String tableFieldName;
    private String structFieldName;
}
```

<font style="color:rgb(63, 63, 63);">任务发布阶段，根据映射关系生成相应的构图 dsl 代码。代码生成主要使用 Velocity 模板引擎框架，其模板如下:</font>

```plain
USE GRAPH ${graphName};

#foreach(${insert} in ${inserts})
insert into ${graphName}(
    #foreach(${strcut} in  ${insert.structs})
    ${strcut.structName}.${strcut.structFieldName},
    #end
    ${END_FLAG}
) select
    #foreach(${strcut} in ${insert.structs})
    ${strcut.tableFieldName},
    #end
    ${END_FLAG}
from ${insert.tableName};

#end
```

**<font style="color:rgb(38, 75, 239);">映射关系需满足如下约束：</font>**

1. 一个目标点或边的数据只能来自一个输入表，而一个输入表可以写入多个点边。
2. 输入表字段类型和目标点边字段类型需要相同。
3. 目标点边上的 meta 字段（点 id，边 srcId, 边 targetId 等）必须插入。

## <font style="color:rgb(63, 63, 63);">Demo 演示</font>

<font style="color:rgb(63, 63, 63);">本示例中以下图为例，图中有 2 种点 person 和 software，以及 2 种边 knows 和 creates。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793045510-afca1d07-33a7-4f6a-b1eb-1d72b042c54c.webp)

<font style="color:rgb(136, 136, 136);">图模型</font>

### 创建点

<font style="color:rgb(63, 63, 63);">在界面中创建 person 和 software 点的 schema。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793045524-3f0e2323-fe02-40f8-97c5-592a2376b244.webp)

<font style="color:rgb(136, 136, 136);">创建 person 点</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793045592-98897b82-65ac-4a66-a492-ed011c2ae392.webp)

<font style="color:rgb(136, 136, 136);">创建 software 点</font>

### 创建边

<font style="color:rgb(63, 63, 63);">在界面中创建 creates 和 knows 边的 schema。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793045570-6c9d2a3e-3866-4f58-9b27-e4bb7090a40e.webp)

<font style="color:rgb(136, 136, 136);">创建 creates 边</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793046206-ff65e1e4-84e7-4dcf-8342-55668d0df766.webp)

<font style="color:rgb(136, 136, 136);">创建 knows 边</font>

### 创建图

<font style="color:rgb(63, 63, 63);">界面中勾选图所需的点边，创建图的 schema， 类型设置为“ROCKSDB”。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793046241-58451068-967f-43d7-b14c-9abc2fa1cfa9.webp)

<font style="color:rgb(136, 136, 136);">创建图</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1756793046409-6698f99b-bc6f-4579-8800-3f3738e9ca98.png)

<font style="color:rgb(136, 136, 136);">配置图</font>

### 创建输入表

<font style="color:rgb(63, 63, 63);">在界面中创建输入表 t_person、t_software、t_creates、t_knows，参数配置中填写对应的文件路径，以 t_person 为例：</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1756793046697-3ad5dde4-dcce-49cc-83fc-65ee08d7f014.png)

<font style="color:rgb(136, 136, 136);">创建输入表</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793046696-8d2dbcab-f176-4abb-9835-8fe0332968c6.webp)

<font style="color:rgb(136, 136, 136);">配置输入表</font>

<font style="color:rgb(63, 63, 63);">测试数据：</font>

```plain
-- person.txt
1,jim,29
2,kate,27
3,tom,32

-- software.txt
4,software1,java
5,software2,c

-- knows.txt
1,2
1,3
3,2

-- creates.txt
2,4,0.2
3,4,0.1
3,5,0.5
```

### 创建集成任务

<font style="color:rgb(63, 63, 63);">在新增图任务中，任务类型选择"集成"，并选择对应的目标图，即自动生成待插入的所有目标点边和字段项。（可根据需求删除不需要插入的目标点边或字段）</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793046841-2a3f3f47-2880-40f5-bbc0-5abf1ebe133c.webp)

<font style="color:rgb(136, 136, 136);">选择点边</font>

<font style="color:rgb(63, 63, 63);">只需在左侧选择每个点边对应的输入表，即可自动填充映射字段。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793046915-da162050-e3d7-4ce6-aaa8-ba40c06f95e1.webp)

<font style="color:rgb(136, 136, 136);">选择输入表</font>

<font style="color:rgb(63, 63, 63);">所有输入表选择完成后，所有表到目标点边的映射项都填充完成，点击"提交"即可创建集成任务。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1756793047023-6131a211-1165-4df9-83be-0b662b27e74b.png)

<font style="color:rgb(136, 136, 136);">配置字段映射</font>

### 提交作业

<font style="color:rgb(63, 63, 63);">任务发布为作业后，可在作业详情界面看到自动生成的构图 DSL 代码，点击提交执行图数据集成作业。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/webp/96961/1756793047447-72d09aea-67f0-4e9c-abdf-c8fa84cb9ced.webp)

<font style="color:rgb(136, 136, 136);">提交作业</font>

### 查看结果

<font style="color:rgb(63, 63, 63);">创建相应的图查询任务，详细见</font><font style="color:rgb(87, 107, 149);">《GeaFlow 交互式图查询：让图所见即所得》</font><sup><font style="color:rgb(87, 107, 149);">[1]</font></sup><font style="color:rgb(63, 63, 63);">，运行后进入查询界面，即可查询到所构图的数据。</font>

![](https://intranetproxy.alipay.com/skylark/lark/0/2025/png/96961/1756793047415-7db75b95-95db-48ff-a05f-361840def4d9.png)

<font style="color:rgb(136, 136, 136);">图查询</font>

**<font style="color:rgb(38, 75, 239);">欢迎关注我们的 GitHub 仓库：</font>**<font style="color:rgb(63, 63, 63);">https://github.com/TuGraph-family/tugraph-analytics</font>
